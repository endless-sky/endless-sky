test-data "conditional choice"
	category "savegame"
	contents
		pilot Bobbi Bughunter
		date 16 11 3013
		system "Terra Incognita"
		planet Ruin
		clearance
		ship "Star Barge"
			name "Buggy Barge"
			sprite "ship/star barge"
			attributes
				category "Light Freighter"
				cost 190000
				mass 10
				bunks 3
				"cargo space" 50
				drag 1
				"engine capacity" 400
				"fuel capacity" 300
				"heat dissipation" 0.8
				hull 1000
				"outfit space" 1300
				"required crew" 1
				shields 600
				"turret mounts" 1
				"weapon capacity" 200
			outfits
				"X1700 Ion Thruster"
				"X1200 Ion Steering"
				Hyperdrive
				"nGVF-BB Fuel Cell"
				"LP036a Battery Pack"
			crew 1
			fuel 300
			shields 600
			hull 1000
			position 0 0
			engine -9 38 1
			engine 9 38 1
			turret 0 -8
			leak leak 60 50
			explode "tiny explosion" 10
			explode "small explosion" 10
			system "Terra Incognita"
			planet Ruin
		account
			credits 100000000
			score 400
			history
		visited "Terra Incognita"
		"visited planet" Ruin
		conditions
			"%TEST%: CONDITIONAL CHOICE"
			# to skip the landing on ruin conversation
			"Ruin: Landing: offered"

test-data "conditional choice goto"
	category "savegame"
	contents
		pilot Bobbi Bughunter
		date 16 11 3013
		system "Terra Incognita"
		planet Ruin
		clearance
		ship "Star Barge"
			name "Buggy Barge"
			sprite "ship/star barge"
			attributes
				category "Light Freighter"
				cost 190000
				mass 10
				bunks 3
				"cargo space" 50
				drag 1
				"engine capacity" 400
				"fuel capacity" 300
				"heat dissipation" 0.8
				hull 1000
				"outfit space" 1300
				"required crew" 1
				shields 600
				"turret mounts" 1
				"weapon capacity" 200
			outfits
				"X1700 Ion Thruster"
				"X1200 Ion Steering"
				Hyperdrive
				"nGVF-BB Fuel Cell"
				"LP036a Battery Pack"
			crew 1
			fuel 300
			shields 600
			hull 1000
			position 0 0
			engine -9 38 1
			engine 9 38 1
			turret 0 -8
			leak leak 60 50
			explode "tiny explosion" 10
			explode "small explosion" 10
			system "Terra Incognita"
			planet Ruin
		account
			credits 100000000
			score 400
			history
		visited "Terra Incognita"
		"visited planet" Ruin
		conditions
			"%TEST%: CONDITIONAL CHOICE GOTO"
			# to skip the landing on ruin conversation
			"Ruin: Landing: offered"


mission "%TEST%: CONDITIONAL CHOICE"
	priority
	source "Ruin"
	to offer
		has "%TEST%: CONDITIONAL CHOICE"
	on offer
		conversation
			# cant actually write an integration test for seeing this or not
			`"You should not see this."`
				to display
					not "%TEST%: CONDITIONAL CHOICE"
			`"Does this work? Do you not see the first sentence?"`
			choice
				`	"No."`
					to display
						has "%TEST%: CONDITIONAL CHOICE"
					accept
				`	"Yes."`
					decline
	on accept
		set "succeed test"

mission "%TEST%: CONDITIONAL CHOICE GOTO"
	priority
	source "Ruin"
	to offer
		has "%TEST%: CONDITIONAL CHOICE GOTO"
	on offer
		conversation
			`"Can you use the hidden path?"`
			choice
				`	"Yes."`
					to display
						has "%TEST%: CONDITIONAL CHOICE GOTO"
					goto canuse
				`	"No."`
					decline
			# just in case the goto is fully ignored
			`	"You should not be here!"`
				decline
			label canuse
			`	"In that case, you have succeeded in this test."`
				accept
	on accept
		set "succeed test"

test "Land On Ruin helper"
	status partial
	description "Helper for landing on Ruin."
	sequence
		input
			command land
		label "landing"
		# empty input to make time pass
		input
		branch "landing"
			"flagship planet: Ruin" == 0

test "Conditional Test"
	status active
	description "Test if a conversation option shows up when the given condition is set."
	sequence
		inject "conditional choice"
		call "Load First Savegame"
		assert
			"%TEST%: CONDITIONAL CHOICE" == 1
		call "Depart"
		call "Land On Ruin helper"
		input
			key p
		# press accept (or decline, depending on if it is shown)
		input
			key "Return"
		input
			key "Return"
		# Depart to refresh the conditions
		call "Depart"
		# use a test-data temporary variable for debugging in case of errors
		apply
			"test: succeed test" = "succeed test"
		assert
			"succeed test" == 1


test "Conditional Test Goto"
	status active
	description "Test if a conversation option shows up when the given condition is set and directs correctly to a label using a goto."
	sequence
		inject "conditional choice goto"
		call "Load First Savegame"
		assert
			"%TEST%: CONDITIONAL CHOICE GOTO" == 1
		call "Depart"
		call "Land On Ruin helper"
		input
			key p
		# press accept (or decline, depending on if it is shown)
		input
			key "Return"
		input
			key "Return"
		# Depart to refresh the conditions
		call "Depart"
		# use a test-data temporary variable for debugging in case of errors
		apply
			"test: succeed test" = "succeed test"
		assert
			"succeed test" == 1
