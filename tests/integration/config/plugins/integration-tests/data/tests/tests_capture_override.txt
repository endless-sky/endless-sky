test-data "quarg capture"
	category "savegame"
	contents
		pilot Bobbi Bughunter
		date 16 11 3013
		system "Terra Incognita"
		planet Ruin
		clearance
		"reputation with"
			Quarg -1000
		ship "Star Barge"
			name "Buggy Barge"
			sprite "ship/star barge"
			attributes
				category "Light Freighter"
				cost 190000
				mass 70
				bunks 3
				"cargo space" 50
				drag 2.1
				"engine capacity" 40
				"fuel capacity" 300
				"heat dissipation" 0.8
				hull 1000
				"outfit space" 130
				"required crew" 1
				shields 600
				"turret mounts" 1
				"weapon capacity" 20
				"thrust" 50
				"turn" 1000
				"energy generation" 10
			outfits
				Hyperdrive
			crew 1
			fuel 300
			shields 600
			hull 1000
			position 0 0
			engine -9 38 1
			engine 9 38 1
			system "Terra Incognita"
			planet Ruin
		account
			credits 100000000
			score 400
			history
		visited "Terra Incognita"
		"visited planet" Ruin
		"available mission" "%TEST%: Wardragon Scanning You!"
			name "%TEST%: Wardragon Scanning You!"
			uuid 9ba505d8-e565-4632-8c7a-c74072b85b5a
			priority
			to offer
				"%TEST%: ILLEGAL CAPTURE" != 0
			destination Ruin
			npc
				uuid 01a921d2-b477-4d80-a19e-11aefb2a6464
				succeed 1
				government Quarg
				personality derelict target
				ship "Quarg Wardragon"
					"uncapturable"
					name Scanner
					sprite ship/wardragon
					thumbnail thumbnail/wardragon
					uuid 7cc5c522-858d-419c-88a7-f240fc5799d7
					attributes
						category "Heavy Warship"
						cost 5900000
						mass 360
						automaton 1
						drag 9.3
						"heat dissipation" 0.5
						hull 50000
						"outfit scan power" 1e+09
						"outfit scan speed" 1e+09
						"energy generation" 10
						shields 160000
					fuel 0
					shields 0
					hull 1000
					position 0 0
					explode "huge explosion" 1
					system "Terra Incognita"
			on offer
				conversation
					label 0
					"You must be scanned or be killed."
						accept
		conditions
			"%TEST%: ILLEGAL CAPTURE"
			"Ruin: Landing: offered"


mission "%TEST%: Capture That Quarg!"
	boarding "capture override"
	to offer
		has "%TEST%: ILLEGAL CAPTURE"
	on offer
		conversation
			`skip this and get your own Quarg automaton!`
				decline
	destination "Earth"


test "Capture Uncapturable With Capturable Override"
	status active
	description "Starts the mission, accepts it and then boards the quarg ship to capture it."
	sequence
		inject "quarg capture"
		call "Load First Savegame"
		watchdog 6000
		# so we can capture
		assert
			"reputation: Quarg" < 0
		# start and accept the mission
		input
			key p
		input
			key d
		call "Depart"
		input
			command board
		label "floating"
		# empty input to make time pass
		input
			key return
		branch "floating"
			not "%TEST%: Capture That Quarg!: offered"
		# skip dialog
		input
			key "return"
		# attempt capture and attack, then close the panel and land
		input
			key c
		input
			key a
		input
			key d
		call "Land On Ruin helper"
		# to refresh the conditions, not sure if needed
		call "Depart"
		# copy the test-data in the temporary conditions for debugging when an issue happens
		apply
			"test: reputation: Quarg" = "reputation: Quarg"
			"test: %TEST%: Wardragon Scanning You!: offered" = "%TEST%: Wardragon Scanning You!: offered"
			"test: %TEST%: Capture That Quarg!: offered" = "%TEST%: Capture That Quarg!: offered"
			"test: %TEST%: Wardragon Scanning You!: failed" = "%TEST%: Wardragon Scanning You!: failed"
			"test: ship model: Quarg Wardragon" = "ship model: Quarg Wardragon"
		assert
			"ship model: Quarg Wardragon" == 1
