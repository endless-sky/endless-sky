# Copyright (c) 2023 by Hurleveur
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <https://www.gnu.org/licenses/>.



mission "Unfettered returning home"
	description "This Hai has asked you to smuggle him out of Unfettered space and bring him to <destination>."
	minor
	source
		attributes "unfettered"
	destination "Hai-home"
	clearance
	passengers 1
	to offer
		has "Unfettered Tribute 3: done"
		random < 40
	on offer
		conversation
			`During the night, you hear a gentle scratching sound on your ship's main hatch. Do you investigate?`
			choice
				`	(Yes.)`
				`	(No.)`
					defer
			`	You grab a flashlight and open the hatch, and find a juvenile Hai there, with a large satchel slung over his shoulder. "You are the <first> <last>, yes?" he says. You nod. He says, "Is it true what is written here?"`
			`	In his hands he is holding a piece of foil paper. You recognize it as the wrapper from one of the food rations that you have been transporting to the Unfettered, the "tribute" that they demand from the peaceful Hai. But having never unwrapped one of the rations, you had not realized that there is writing on the inside, a few words in the angular alphabet of the Hai. The Unfettered youth sees your look of confusion, and translates the message. "It says, 'Hai-home is your home too. Rejoin your people.'"`
			choice
				`	"I think it is true. The Hai who gave this tribute said they hoped the Unfettered would turn from violence and be reconciled with them."`
					goto true
				`	"I'm sorry, but I don't think they will ever let you live among them, if it is your nature to be prone to violence."`
			`	You have little experience reading Hai emotion, but the youth seems crestfallen. "You are certain?" he asks.`
			choice
				`	"I am certain. I can do nothing for you."`
					goto refuse
				`	"Perhaps you can come with me and find out, but don't get your hopes up."`
					goto end
			label true
			`	"Will you take me to Hai-home?" he asks. "You are able to be outside Unfettered places. Can I go with you?"`
			choice
				`	"Yes, I will take you there."`
					goto end
				`	"Sorry, I can't risk angering the Unfettered by carrying a defector."`
			label refuse
			`	Disappointed, the youth leaves. You hope you made the right choice.`
				decline
			label end
			`	You show the youth to one of your bunk rooms, and tell him to stay hidden there until you reach Hai-home.`
				accept
	
	on visit
		dialog `You look for the young Hai, but realize that he took a ride on one of your escorts! Better depart and wait for your escorts to arrive in this star system.`
	on complete
		payment 100000
		dialog
			`You need not have worried about the reception the Unfettered youth would receive here on Hai-home. Scarcely minutes after you hesitantly contact the Hai government, a happy crowd has gathered around your ship. When he steps out of the hatchway, he looks stunned at being welcomed so warmly. One of the Hai governors thanks you for transporting him, and pays you <payment>.`
		"reputation: Hai" += 10
		"reputation: Hai (Wormhole Access)" += 10
		"reputation: Hai Merchant" += 10
		"reputation: Hai Merchant (Human)" += 10
		"reputation: Hai Merchant (Sympathizers)" += 10



ship "Ancient Ladybug"
	swizzle 0
	sprite "ship/hai ancient ladybug"
	thumbnail "thumbnail/hai ancient ladybug"
	attributes
		category "Medium Warship"
		"cost" 8950000
		"shields" 12300
		"hull" 3600
		"required crew" 11
		"bunks" 33
		"mass" 280
		"drag" 5.4
		"heat dissipation" .85
		"fuel capacity" 900
		"cargo space" 91
		"outfit space" 460
		"weapon capacity" 170
		"engine capacity" 120
		# Disabled faster due to the ship's sea time, which the Unfettered know about
		"threshold percentage" 0.4
		# Expensive features mentioned in description:
		"ramscoop" 0.25
		"cargo scan power" 5
		"cargo scan efficiency" 16
		"outfit scan power" 17
		"outfit scan efficiency" 15
		"tactical scan power" 25
		"atmosphere scan" 100
		"asteroid scan power" 30
		
		weapon
			"blast radius" 100
			"shield damage" 1000
			"hull damage" 500
			"hit force" 1500
	outfits
		`"Biroo" Atomic Steering`
		`"Biroo" Atomic Thruster`
		"Boulder Reactor"
		"Bullfrog Anti-Missile" 2
		"Cargo Expansion" 2
		"Hai Diamond Regenerator"
		"Hai Fissure Batteries"
		"Hai Williwaw Cooling"
		Hyperdrive
		"Ion Cannon" 3
		"Quantum Keystone"

	gun 0 -69.5 "Ion Cannon"
	gun -12 -68.5 "Ion Cannon"
	gun 12 -68.5 "Ion Cannon"
	turret -36 3 "Bullfrog Anti-Missile"
	turret 36 3 "Bullfrog Anti-Missile"
	engine -36 62 0.8
	engine 36 62 0.8
	explode "tiny explosion" 20
	explode "small explosion" 45
	explode "medium explosion" 50
	explode "large explosion" 40
	explode "huge explosion" 10
	"final explode" "final explosion large"
	description "This sensor-laden exploration vessel hails back to a more peaceful era of the Hai. Though they have no true ramscoop, a technology the Hai never developed, their built-in collection gills magnify the natural ramscoop present in all ships. These expensive features are the reason the ship has been replaced with the Lightning Bug."
	description "This ship can be used as an agile, long distance cargo hauler and blockade runner. It is able to defend itself in small skirmishes, even though it does not operate at its full potential, having stayed underwater for some time... The simple fact that it is still running at all is proof of the durability of Hai technology."

mission "Hai Legacy 1"
	invisible
	landing
	shipyard
	source "Hai-home"
	destination "Firelode"
	clearance
	to offer
		has "First Contact: Unfettered: offered"
		"reputation: Hai (Unfettered)" < 0
		not "Unfettered Jump Drive 1: offered"
		not "event: hai ladybug available"
	on offer
		conversation
			branch first
				not "Hai Legacy 1: deferred"
			`Do you want to head to the coordinates as the hooded figure suggested the previous time?`
			choice
				`	(Sure.)`
					goto go
				`	(Maybe another time.)`
					defer
				`	(Never.)`
					decline
			label first
			`As you enter the shipyard you quickly get approached by a hooded figure. They come to address you discreetly, and, seeing you stop to listen, they take your arm and make you follow them. "Keep walking," they say, taking a look around the way someone looking for a new ship would, pointing at one with little conviction before addressing you again. "My associates and I have a lucrative business proposition for you. If you are interested go to these coordinates." They give you a piece of paper with the location, a beach on the other side of the planet, before quickly fading into the crowd. Will you go there?`
			choice
				`	(Sure.)`
				`	(Maybe another time.)`
					defer
			label go
			`	As you ponder how to make your way to the rendezvous point, you notice a convenient train ticket in your pocket, with instructions on how to find your way to the destination. You proceed to take the train, and then have to walk for hours to get the rest of the way there.`
			`	You look around you, double checking you are indeed at the right coordinates, for except a cave, vegetation, and, of course, the beach, you cannot see much of interest in the vicinity. You can't help but keep your hand close to your gun, feeling safer with its presence.`
			`	After waiting for what seems like an eternity you spot two hooded figures approaching you, whispering amongst themselves. You start to doubt whether or not this was a good idea, but it is probably too late to back down now. They come to address you, their face somehow impossible to glimpse at, even below the hoodie. "Hello, <last>," they say at the same time, almost in a comical way, removing some of the tension you felt until now. Then they look at each other, nod, and one of them addresses you in a more serious tone. "We are sorry for all of these complications, but the truth is, we cannot afford to take risks. You see, we simply do not know how you might react. Furthermore, it is best for all if you do not come to know us."`
			choice
				`	"Tell me more."`
					goto tellme
				`	"How do you know me?"`
					goto know
				`	(Run away).`
			`	They seem surprised at your sudden change of mind, but make no effort to stop you.`
			label trainback
			`	You proceed to head to the nearest spaceport by getting yourself another train ticket, without any incidents.`
				decline
			label know
			`	They grin, "You need to become known by the Hai in order to land on our homeworld."`
			`	"We know you have provided help, by doing various jobs."`
				to display
					"reputation: Hai (Unfettered)" >= -1250
			`	"Do not think we are unaware of your skirmishes with the Unfettered," they add with a serious tone.`
				to display
					"reputation: Hai (Unfettered)" < -1250
			label tellme
			`	Suddenly, you hear a loud roar behind you as the ground begins to shake.`
			`	Turning back towards the sea where the noise is coming from you see the waves getting more agitated and the wind rise as a shape emerges out of the water surrounded by fumes, as if an ancient sea monster was arising from the depths.`
			`	But it is no monster. Indeed it is so, so much worse.`
			`	It is a ship, and its guns are pointed straight at you!`
			scene "scene/emerging ladybug"
			choice
				`	(Run.)`
				`	(Wait.)`
					goto wait
				`	(Try to contact my fleet for help.)`
				`	(Shoot it!)`
					goto dumb
			`	As you try to react to this sudden threat, the Hai closest to you firmly grabs your arm and shouts to get trough the noise. "Wait! If this ship wanted to kill you, <last>, you would already be dead."`
			label wait
			`	You are having a hard time hearing anything with the sound of the engines as the ship proceeds to land on the beach. Suddenly, all is calm.`
			`	They turn to you, surprisingly calm in this situation. "Lucky for you, this is our ship. But not any ship! This is a mighty relic of the past, from the times our Empire used to control the stars: a Ladybug!`
			choice
				`	(Say nothing.)`
					goto explain
				`	"You could have told me before."`
			`	"Yes, but where is the fun in that? We also wanted to see how you would react.`
			label explain
			`	"We have a very interesting proposition for you: should you agree to bring supplies to our brethren, the Unfettered Hai, we will sell this ship to you for the modest price of 6.5 million credits. This is a very useful ship, and you should be able to repay this quite easily by running more of the same kind of jobs. These supplies are needed on short notice, on <destination>, and we lack the time and personnel to bring them."`
			`	"Of course, the ship has some... drawbacks, compared to its golden time, and you should not expect the best price in a shipyard either. Nevertheless it is a fine vessel, capable of safely taking a respectable amount of cargo across large distances! So, what do you say, <last>? This is the opportunity of a lifetime; they simply don't make ships like these anymore!"`
			choice
				`	"I will take this deal."`
					goto take
				`	"I have no interest in this deal."`
			`	"A shame. We will probably not meet again," they say, before signaling the ship to submerge into the ocean again.`
				goto trainback
			label take
			action
				give ship "Ancient Ladybug" "Good Omen"
				fine 6500000
				log "Accepted a somewhat shady deal for an old Hai ship, a Ladybug, that seems to still be in good functioning state."
			`	They give you access to the ship and proceed to explain the details. "It is of no real significance, but surely you understand we cannot go trough official means for this, we will have to present it as a fine. Worry not, we will make it something of no consequence, like an old Korath forbidden tech you would not have known about, that we had to confiscate."`
			`	You quickly realize they are not asking you for your opinion at all. In fact, you notice the fine has already been issued before you could say anything. "We will need to make some modifications to the anti-missile system of the ship before you can use it. Once you get the ship into a shipyard I would advise against repainting it, you will understand why later. And I would not bother removing the rust if I were you, it is not worth the risk."`
			`	"Oh, and I almost forgot: make sure you visit the spaceport to get the cargo loaded onto your ship!"`
				accept
			label dumb
			`	You get your weapon out and proceed to shoot on the ship.`
			branch lucky?
				random < 2
			branch lucky??
				random < 40
			`	You shoot the ship, but the small weapon has no chance of doing anything to the heavy armor, even in its current state. The ship's speakers then activate, almost deafening you. "MY TURN!"`
			`	The ship then cuts you down with surgical accuracy using its Bullfrog Anti-Missiles. You can still hear the two Hai speaking to each other in a surprised tone. "How did this one survive so lon..." And everything goes dark.`
				die
			label lucky??
			`	You manage to land a lucky hit on what you assume to be the ship's navigation system, because it comes down, seemingly crashing.`
			`	Except that it crashes right on you, and it seems more like a landing than an actual crash, especially considering the Hai are left mostly untouched, having taken a few leaps back right in time.`
				die
			label lucky?
			`	Probably thanks to the fact the ship's shields are down, and of its depreciated state, you manage to land a very lucky shot, going trough a layer of rust and severely damaging the reactor of the ship.`
			`	At least, it might have seemed lucky until it blew up, taking you and everyone else on this beach down with it.`
				die
	on defer
		set "Hai Legacy 1: deferred"

mission "Hai Legacy 2"
	autosave
	landing
	name "Heritage reclaimed"
	description "Use the newly acquired Ancient Ladybug to bring aid to the Unfettered Hai, with it as your flagship and preferably without any other ships."
	clearance
	# deadline to make sure you don't just enjoy free rep
	deadline 30
	cargo "food (aid)" 121
	source "Hai-home"
	destination "Firelode"
	blocked "You need space for the agreed rush cargo of food to Unfettered space on the Ancient Ladybug, and should use it as flagship, preferably as your only ship."
	to offer
		not "Hai Legacy 1: declined"
	to accept
		has "flagship model: Ancient Ladybug"
	on offer
		conversation
			`Going into the spaceport one could say the cargo finds you more than you found it: a worker comes to you with crates, which are already allocated in your name for this ship. All that is left to do is to bring it to <destination> for the big promised sum of <payment>.`
			choice
				`(Prepare for takeoff.)`
			`	As you head to the bridge, preparing to take off from the planet, you notice a message on the command panel, probably from the "associates".`
			`	It reads: "You should use the Ladybug as your flagship and you should not bring any other ships."`
			`	Given the dangers of Unfettered space, you figure it would be a good idea to familiarize yourself with the design, and maybe to modify it, especially if you are to go with only this ship.`
	on enter
		system
			attributes "unfettered"
		conversation
			branch "not single ship"
				"total ships" != 1
			`As you enter the system, you prepare for a fight to get the cargo through, but, surprisingly, it is very quiet this time.`
			`	Indeed, for the first time, entering Unfettered space does not mean getting shot at by missiles from all sides.`
			`	They are not hailing you either. Perhaps they think you are one of the Hai aiding them, especially given your cargo and the ship you are flying.`
			action
				"old reputation: Hai (Unfettered)" = "reputation: Hai (Unfettered)"
				"reputation: Hai (Unfettered)" >?= 0
			label "not single ship"
			`You enter the system, and, for a brief moment, nobody is shooting you.`
			`	The Unfettered quickly change their mind, however, and happily head your way, weapons ready, most probably with the intention of looting your cargo.`
			`	You figure you should only have come with the Ancient Ladybug, as the associates suggested.`
	on fail
		"reputation: Hai (Unfettered)" <?= -1000
		dialog `The Unfettered and their associates are not clearly happy when they somehow find out you did not get the cargo there in time. "You will have to prove yourself another way."`
	on visit
		dialog `You have reached <planet>, but you either did not bring the Ancient Ladybug, some of the cargo was on another ship, or you are not using the Ladybug as your flagship. You should park your fleet and only use the Ancient Ladybug.`
	to complete
		has "flagship model: Ancient Ladybug"
	on complete
		dialog `You receive a message from the 'associates of Hai-home', "thank you for helping our brethren, <last>. We will not forget this. Please accept these <payment> to get you started on paying back."`
		payment 1000000
		log "Delivered a pressing food cargo to the Unfettered using a newly acquired but rather old Ladybug. They seem to not be firing on me, for now at least."



# no category, meaning you can't remove it from the Ladybug
outfit "Unfettered Landing Permit"
	"maintenance costs" 681
	description "This item is needed in order to land on Unfettered planets, and its loss will cancel the arrangement."

mission "Hai Legacy 3"
	name "Ancient claim"
	description "Beat the Lightning Bugs in a merciless fight. You only have one day, and being disabled will result in losing the fight."
	landing
	source "Firelode"
	deadline
	to offer
		has "flagship model: Ancient Ladybug"
		has "Hai Legacy 2: done"
	on offer
		conversation
			`As you land and exit your ship, you quickly notice you have attracted a lot of attention, probably due to its old design. One Unfettered that looks like an engineer comes to speak to you, warmer than usual. "Welcome. I do not know how you have obtained this ship, although I imagine some of us will see it as a sign. It is a relic of our past, a past we are quite proud of.`
			`	"As such, most will say that you have no right to use that ship. Luckily for you, I do not believe in any of that. What matters to me is that this ship is very durable, given the time it obviously spent in the water. It also has ancient technology that would be very valuable to us."`
			`	They raise their voice for everyone to hear, "I challenge you! The winner will earn the right to own this relic."`
			choice
				`	"What do I get if I win?"`
					goto win
				`	"Can't I just sell it to you?"`
			`	"No, because in the eyes of my brethren that would mean I did not deserve this ship."`
			label win
			`	"You will win the right to access our worlds for just a meagre daily fee of 500 credits. In order to keep our respect, and to not lose out on this priceless artifact, this Ancient Ladybug may not be destroyed or sold. You will not be allowed to land so easily as you just did, should you refuse.`
			`	"Beware, for there are no rules, other than the fact you may only use this one ship. Tell me then, what say you, will you take to the skies, or are you too afraid?"`
			choice
				`	"I accept."`
				`	"I have nothing to prove to you."`
					decline
			`	"Good! I will of course not be fighting you personally, as it is too risky to do so. I would also not want to deny my brethren the opportunity to prove themselves against a mighty human warrior!"`
			`	You are not sure if they are being serious or not, but their friends seem to be in for it. Their leader approaches you. "So you think you deserve to fly this mighty ship of the Hai empire?"`
			`	"Yeah, what makes you think that, human?" Another one adds.`
			choice
				`	(Say nothing.)`
				`	"Are you trying to scare me out of the fight?"`
					goto scare
			`	"I guess we'll find out." Says a third.`
			label scare
			`	The leader gets closer and addresses you in a more serious tone, "You should be aware, <last>, that this is not a friendly competition between allies. As far as I am concerned, you are an enemy. You should see it more as a fight for you to truly earn this ship, and more, but make no mistakes: it has only two rules: nobody else than us may interfere, and being disabled results in losing the fight. And do not even think about bringing more than this Ladybug as a flagship or we will not bother showing up!"`
			# this is a "warning" for the incoming extra ship that happens because you killed/captured 10 Shield Beetles
			# (but in reality with disabling a lot of ships it goes faster than that)
			`	They suddenly look at you intensively, straight in the eyes, "We sometimes bend the rules for our friends, but that is not your case," they say with a sudden change of tone, before leaving.`
				to display
					"reputation: Hai (Unfettered)" < -2000
			`	The engineer comes back, looking a bit impatient, "Are you going to talk all day, or are you going to fight?" The Unfettered pilots immediately head to their ships to get the initiative. The engineer utters a word to you once they are far enough away, "I want this done by the end of the day, do not try my patience. You are lucky I offered this deal in the first place, make sure I do not regret it. Now, quick, get to your ship!" You see the contestants have already begun the launching procedures, and launch as soon as you can.`
			`	(Remember to park your other ships and make sure your flagship is the Ancient Ladybug.)`
				accept
	on decline
		"reputation: Hai (Unfettered)" >?= -1000
	on disabled
		fail "Hai Legacy 3"
		dialog `The enemy ships hail you, "You have failed the challenge. We will take the technology we want when you land, and have already arranged to sell you replacements for it, for this fine of <fine>."`
		fine 1500000
	on fail
		"reputation: Hai (Unfettered)" >?= -1000
		dialog `The Unfettered hail you, "You failed to complete the duel properly, and as such, are no longer authorized to land on our worlds. You will not enjoy unwarranted respect any longer!"`
	npc disable
		government "Hai (Unfettered Challenger)"
		to spawn
			"total ships" == 1
			has "flagship model: Ancient Ladybug"
		to despawn
			"total ships" != 1
		personality unconstrained launching plunders staying target heroic disables
		ship "Lightning Bug (Ionic)" "Erazer"
		ship "Lightning Bug" "Thunder"
		ship "Lightning Bug (Unfettered Shipyards)" "Lighting"
		ship "Lightning Bug (Pulse)" "Struck"
		conversation
			`You receive a message from the remaining Unfettered ships: "We surrender." You remember you were asked to land on the same day in order to claim your reward of permanent access to Unfettered space.`
			branch "good boy or bad boy enough"
				has "unfettred: beaten extra bugs"
				"old reputation: Hai (Unfettered)" < -2000
			`	"Do not shout victory too soon, however, for we were not the only ones you had to beat," they add.`
			label "good boy or bad boy enough"
			action
				set "unfettered: beaten the bugs"
	npc disable
		government "Hai (Unfettered Challenger)"
		to spawn
			"old reputation: Hai (Unfettered)" < -2000
			has "flagship model: Ancient Ladybug"
			"total ships" == 1
		to despawn
			"total ships" != 1
		personality unconstrained entering plunders staying target heroic
		ship "Sea Scorpion (Shredder)" "Requiem"
		system "Hi Yahr"
		dialog "You have managed to defeat the last of the Unfettered challengers, it is now time to land to claim your reward."
		on disable
			set "unfettred: beaten extra bugs"
	npc
		government "Hai (Unfettered)"
		ship "Lightning Bug (Unfettered Shipyards)"
		personality launching staying surveillance
		on kill
			fail "Hai Legacy 3"
	on visit
		dialog "You have not beaten all challenging ships yet. If they have not shown up it is probably because you have cheated and brought more ships into the fight. Load an earlier save and try again if you want to finish this mission."
	to complete
		has "unfettered: beaten the bugs"
		has "flagship model: Ancient Ladybug"
		or
			"old reputation: Hai (Unfettered)" > -2000
			has "unfettered: beaten extra bugs"
	on complete
		conversation
			`The engineer seems shocked at first. "You really... won? It really was close until the end, was it not? Or did the captains already make stories to justify their incompetence?"`
			choice
				`	"Indeed, but it was fun."`
					goto next
				`	"What are you talking about? This was easy!"`
			`	"Don't become overconfident now, captain. I am sure you know what happens to such people.`
			label next
			`	"I must congratulate you, I never expected you had it in you. I only have one word and will give you authorization to land, on the condition that you keep this relic from our past in good condition!`
			`	"Make sure you do not lose it until you earn the right to call us friends, or we will take it very seriously. Oh, and there are taxes on the daily fee. I hope you don't mind."`
		outfit "Unfettered Landing Permit"
		log "Managed to use an old ladybug to beat a few Lightning Bugs, earning myself a place in Unfettered territory for a daily cost, as long as the Ancient Ladybug is kept intact."

mission "Unfettered Landing Permit Lost"
	landing
	invisible
	source
		attributes "unfettered"
	to offer
		has "Hai Legacy 3: done"
		not "outfit (all): Unfettered Landing Permit"
		not "Unfettered Jump Drive 1: offered"
	on offer
		dialog "As you land the Unfettered tell you they have learned of the loss of the Ladybug, thereby ending your landing access and friendly relations with them until you give them a Jump Drive."
		# since you had to have that ship as a flagship when you received the license that means that if you lose the license you lost the ship
		log "Lost the Ancient Ladybug and friendly access to Unfettered space with it."
		"reputation: Hai (Unfettered)" <?= -1
		fail

mission "Free Permit"
	landing
	invisible
	source
		attributes "unfettered"
	to offer
		has "Unfettered Jump Drive 1: offered"
	on offer
		outfit "Unfettered Landing Permit" -1
		fail
