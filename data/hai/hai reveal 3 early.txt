# Copyright (c) 2020 MasterOfGrey
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.  See the GNU General Public License for more details.

########################################################################

event "secret mountaintop"
	# Ensure Mountaintop exists so the next mission can trigger
	system "Ultima Thule"
		government "Uninhabited"
		object
			sprite star/f0
			period 10
		object
			sprite planet/desert5
			distance 200
			period 22.3607
		object
			sprite planet/europa-b
			distance 403.41
			period 64.056
		object
			sprite planet/desert7-b
			distance 824.9
			period 187.302
		object
			sprite planet/gas1
			distance 1706.99
			period 557.553
			object
				sprite planet/ice8-b
				distance 216
				period 11.1964
		object "Wormhole Alpha"
			sprite planet/wormhole
			distance 4208.63
			period 2158.5
			object Mountaintop
				sprite "effect/flotsam yottrite"
				distance 315
				period 31.1964
	planet Mountaintop
		government "Unknown"
		# Placeholder description; you can't actually land.
		description `This tiny asteroid has a space hazard warning transmitter, of a type typically used to mark construction sites. Perhaps someone intends to build a space station here?`
		"required reputation" 1000
		bribe 0

mission "Hai Building Mountaintop [1] Construction Fleet"
	name "Escort construction fleet to Ultima Thule"
	description "Meet a construction fleet at <stopovers> and escort them to to <destination> to prevent a confrontation."
	autosave
	landing
	source "Hai-home"
	stopover "Makerplace"
	destination "Mountaintop"
	clearance
	to offer
		has "Hai Leaks Response 6: done"
	on offer
		conversation
			`When you return to Hai-home you are directed now to a government hangar where you are met by Xilin and Sayari, both looking very relieved.`
			`	"I am very glad to see you returned Captain <last>, Sayari said you were away on an important errand but I've been hoping for a day now you would appear, as I think you might be the solution to the current impasse."`
			`	"You see," says Sayari, "in the light of the recent civil war your species has had, some of the Elder's are less than keen with allowing a partisan observer to see the inner workings of a station in its earliest phases, especially when we haven't built one in so, so long."`
			`	Now that she mentions it, you don't think you've seen a Hai station at all.`
			`	"However, therein lies a problem," says Xilin.`
			`	"The Republic will not allow the Hai to build a station this side of the wormhole without some oversight by someone we trust. This has now been a point of contention for some days, and multiple suggestions have been rejected."`
			`	Sayari chitters, "Honestly it's all very silly. Lots of old men who are meant to be friends concerned that the other might have been lying to them."`
			`	In an oddly comical gesture they both shrug at the same time.`
			`	"Anyway, thanks to a little Freedom of Information request to the Republic, I have been looking at things and I think I have the solution."`
			choice
				`	"Is it me?"`
			`Sayari winks at you, "Catch on quick don't you."`
			`	"The actions you're recorded as having taken show a certain conscience for the good of your species as a whole, despite your affiliations. I have convinced the other diplomats and the Elders that you might be a viable solution to this impasse. The human diplomats have already agreed, but the Elders wish to speak with you first."`
			choice
				`	"Who are these Elders?"`
				`	"Of course, that's natural."`
					goto main
			`	Sayari explains, "The Hai are ruled by an elected 'Council of Elders', they are not responsible for every administrative decision that occurs but they are the highest authority of our government. Their decisions are final, at least for the term of an election."`
			label main
			`	"If you're willing, there will be a council meeting in an hour, I can put you first on the agenda. Will you do this?" asks Sayari.`
			choice
				`	"I suppose I must."`
					goto council
				`	"Someone better be paying me for this."`
					goto council
				`	"Of course, let's do it."`
					goto council
				`	"Maybe in a bit, I should do something else first."`
					defer
			label council
			`Following Sayari you pass beyond a security checkpoint where Xilin is prevented from following you. Sayari speaks with another hai doing administrative work for a moment before gesturing you to a private antechamber.`
			`	"We shouldn't have to wait very long, but while we're alone," she glances at the door as if faintly nervous for a second, "did you find anything on your investigation?"`
			choice
				`	"Yes, actually I found proof."`
				`	"Unfortunately, I did find something."`
			`	You hand Sayari a data stick, "I have saved everything from my logs on there."`
			`	Sayari looks crestfallen and takes the data stick gingerly, looking at it as if it were some snake that might bite her at any moment.`
			`	"I will have a look," is all she says.`
			`	No sooner has she pocketed it than there is a knock at the door and an aide looks in, "The Council will see you now."`
			`	The next twenty minutes prove to be an exercise in tedium as various members of the council interrogate you over apparently mundane details of your recent actions as recordsed in the FOI report. You're not really sure what most of it has to do with anything, but eventually one of the elders stands up.`
			`	"I think we've generally had enough of this here, answer me two questions and we shall make our decision," he says.`
			`	"Do you think that a diplomatic post should be able to defend itself? Or should it trust to the strength of those who meet there to ensure its protection?"`
			`	This seems like a very strange question...`
			choice
				`	"It should be strong enough to defend itself. You cannot trust your enemy."`
					goto trust
				`	"Both sides must be trusted to protect a diplomatic post, or there is no point to having one."`
					goto caution
			label trust
			apply
				set haitrust
			goto return
			label caution
			apply
				set haicaution
			label return
			`	You seem to get no reaction and the Elder follows up with, "What is the gravest threat, in your opinion, facing humanity?"`
			choice
				`	"The Pug"`
				`	"The Alphas"`
				`	"Unknown Jump-Capable Aliens"`
				`	"Experimental Technologies"`
				`	"Hubris"`
					goto wise
			`	There is a collection of chittering laughs from the various council members. You're not sure if there was something wrong with what you said but you aren't left long to ponder.`
			`	"It seems the human agent is an honest fool, but an honest fool can at least be trusted to be foolish honestly on all fronts."`
			`	You're pretty sure you should be offended by that, but the councilmembers are smiling and don't look like they're about to evict you.`
			goto end
			label wise
			`	"It seems you learnt the correct lesson from the crisis of your species," he says.`
			`	You see several appreciative nods happening around the room out of the corner of your eyes.`
			label end
			`	"You may act as the oversight for the human governments in this project. Proposal D-86513-7P4 is approved. Council adjourned."`
			`	When you meet Sayari afterwards a touch of her usual enthusiasm has returned.`
			`	"This is fantastic news, now all that remains to be done is for you to escort the construction fleet from Makerplace to Ultima Thule and observe the initial stages. They'll be waiting for your arrival on Makerplace."`
				accept
	on accept
		event "role-play station before construction"
		log `The diplomats have elected to double-down on the role-play community angle, citing it's success. However, the Hai are unwilling to trust a human government to see the inner workings of a station under construction in the wake of the civil war, and the Republic will not allow a station to be built on their side unsupervised. You have been asked to fulfill the role of supervisor as a result. The Elders asked you some odd questions, but agreed that you were an acceptable individual for the task.`
	on stopover
		dialog `A fleet of seven Geocoris are waiting to accompany you when you arrive, with just the final items being loaded as you come into land. They will follow you to the site where the new station will be built.`
	on complete
		event "role-play station after construction"
	

mission "Hai Building Mountaintop [1a] Construction Escorts"
	landing
	invisible
	source "Makerplace"
	destination "Mountaintop"
	clearance
	to offer
		has "Hai Building Mountaintop [1] Construction Fleet: active"
	on visit
		dialog `You have arrived without the seven Geocoris you are escorting from <origin> to <destination>. You must take off and wait for them to finish this mission.`
	npc accompany save
		personality escort timid
		government " Hai "
		ship Geocoris "Du Cor Hey"
		ship Geocoris "Mon Yo Sen"
		ship Geocoris "Vai e Lur"
		ship Geocoris "Du Woa Ow"
		ship Geocoris "Luf Sook Hey"
		ship Geocoris "Du Eh"
		ship Geocoris "Mon e Ow"
		ship Geocoris "Eek lo Pok"

mission "Hai Building Mountaintop [1b] Return"
	landing
	name "Return to <planet>"
	description `The Hai have another job for you at <destination>.`
	source "Mountaintop"
	destination "Hai-home"
	clearance
	to offer
		has "Hai Building Mountaintop [1a] Construction Escorts: done"
	on offer
		conversation
			`On arrival, you see one of the Geocoris deploy a steel ring around itself. Space-based cranes set about removing the three outer sections of the Geocoris and moving them to the steel ring. After they finish with the first, they progressively dismantle the other seven Geocoris you escorted. Within a few hours, there is a makeshift station with eight Geocoris power generators and a sizable amount of storage and habitat space. The construction workers begin unpacking the contents of the Geocoris storage pods, checking construction seals, engaging principle life support systems, and a massive holoprojector.`
			`	The Geocoris captains explain the Hai had conceived this space station option when the geocoris was first designed, with some station construction principles used to support its massive cargo capacity. With minor modifications it was a made a trivial effort to dismantle eight Geocoris and rapidly assemble a station. They thank you for your service, and inform you that the Hai government needs your help again.`
			`	Content that the station is built satisfactorily, you prepare to return to <destination>.`
				accept


event "role-play station before construction"
	system "Ultima Thule"
		object
			sprite star/f0
			period 10
		object
			sprite planet/desert5
			distance 200
			period 22.3607
		object
			sprite planet/europa-b
			distance 403.41
			period 64.056
		object
			sprite planet/desert7-b
			distance 824.9
			period 187.302
		object
			sprite planet/gas1
			distance 1706.99
			period 557.553
			object
				sprite planet/ice8-b
				distance 216
				period 11.1964
		object "Wormhole Alpha"
			sprite planet/wormhole
			distance 4208.63
			period 2158.5
			object Mountaintop
				sprite "effect/flotsam yottrite"
				distance 315
				period 31.1964
	planet Mountaintop
		government "Hai"
		attributes uninhabited
		landscape land/station0
		description `There's a construction site rapidly assembling a station from Hai Geocoris' orbiting this wormhole.`
		"required reputation" -10
		security 0.2


event "role-play station after construction"
	system "Ultima Thule"
		object
			sprite star/f0
			period 10
		object
			sprite planet/desert5
			distance 200
			period 22.3607
		object
			sprite planet/europa-b
			distance 403.41
			period 64.056
		object
			sprite planet/desert7-b
			distance 824.9
			period 187.302
		object
			sprite planet/gas1
			distance 1706.99
			period 557.553
			object
				sprite planet/ice8-b
				distance 216
				period 11.1964
		object "Wormhole Alpha"
			sprite planet/wormhole
			distance 4208.63
			period 2158.5
			object Mountaintop
				sprite "planet/station hai eight geocoris dim"
				distance 315
				period 31.1964
	planet Mountaintop
		government "Hai"
		attributes uninhabited
		landscape land/station0
		description `This station is made of eight Geocoris ships dismantled and reassembled into a spherical structure with external storage and landing platforms. Hai workers are wandering the station, installing human amenities and vast holographic projection systems. Presently it looks much like a construction site, but it is rapidly approaching completion.`
		security 0.2


mission "Hai Building Mountaintop [2] Recruits"
	name "Encourage recruits for Mountaintop"
	description "Now that the station is going ahead, the Hai need to recruit some people to play the part. Someone needs to sell it to them though."
	landing
	source "Hai-home"
	stopover "Makerplace"
	stopover "Darkmetal"
	stopover "Giverstone"
	stopover "Stonebreak"
	stopover "Cloudfire"
	stopover "Snowfeather"
	stopover "Icelake"
	stopover "Newhome"
	stopover "Frostmark"
	stopover "Heartvalley"
	stopover "Allhome"
	stopover "Dustmaker"
	stopover "Greenbloom"
	stopover "Skyfarm"
	stopover "Farwater"
	stopover "Greenwater"
	destination "Mountaintop"
	clearance
	passengers 1
	blocked `Terry contacts you and says, "Captain, you're going to need a bunk free for me. Do you have space?" You do not, so you should complete or abort another mission to make room for her, then return here.`
	on visit
		dialog `You have arrived at the Mountaintop construction site but it isn't finished or staffed yet.`
	to offer
		has "Hai Building Mountaintop [1b] Return: done"
	on offer
		conversation
			`At Hai-home you are directed to a now familiar government hangar.`
			`	Sayari, Xilin, and Alondo all send you greeting pings, but are busy at the time of your landing. To your surprise though, Terry is banging on your airlock before too long.`
			`	"Captain <last>, or should I call you <first>? Anyway, doesn't matter. How would you like to make some money?"`
			`	The smile she gives you is something like you imagine a large cat giving the tasty morsel it just identified as its food.`
			`	"Of course you do, everyone likes to make money," she says.`
			`	"The Hai have put out the call for volunteers to staff the new Mountaintop station when it's finished. While you've been off watching early construction works, we've been gauging public interest and well... it's not going to work. In order to sell this they're going to need at least four thousand volunteers by the end of the week to get a good handle on what they can expect to need in terms of facilities, amenities, supplies, and various livability requirements. Nearly twelve thousand by the time the station is actually built. Our current estimates suggest they'll reach a quarter of that."`
			`	As she's talking Terry has been laying out charts and graphs, and using a handheld Hai holographic device that she seems to have picked up somewhere to show animated diagrams.`
			choice
				`	"How do you know all this?"`
			`	Terry raises an eyebrow at you, "You remember we have a supercomputer that could predict the economic situation across the whole of human habited space up to fifty years in the future to within 1% accuracy right?"`
			`	When she puts it that way, it does suddenly feel like a bit of a stupid question.`
			`	"As it turns out, that same computer is predicting that the Syndicate stands to lose billions of credits, per day, for the duration of any crisis evolving from this which involves the uncontrolled release of the Hai secret; however, we have a plan."`
			choice
				`	"Oh yes?"`
				`	"What's the deal then?"`
			`	Terry crosses her arms and leans back against the bulkhead, "We need a recruitment campaign, and if you haven't guessed, you're the man to do it."`
			`	"The Syndicate will offer you a sum of 10,000,000 credits to visit every planet in Hai space and do glossies. I will stage manage, and have promotional material ready inside of 3 hours."`
			choice
				`	"I don't really have a choice in this matter do I?"`
			`	Terry's answering grin was... predatory.`
				accept
	on stopover
		conversation
			`You have finally visited every world in Hai space and sold the pitch to the people. With any luck enough people will sign up to make it work.`
			`	Terry indicates that you may now take her to Mountaintop without further stops, but she has some leftover materials so she'll get you to do some final spruiking if you stop anywhere else along the way.`
	on complete
		log `You had to go on a lengthy promotional tour to rustle up volunteers for the new station. Terry took care of all the details and seemed especially keen. Presumably she has some marketing background, which may explain her success within the Syndicate.`
		payment 10000000
		conversation
			`You land on the world of <planet> and do your part to sell the opportunity on Mountaintop. Shortly after you receive a ping informing you that <payment> has been deposited into your account. Terry must've set it up to happen automatically.`
				decline



mission "ZZ Hai Building Mountaintop [2a] Sales Job"
	landing
	invisible
	repeat
	source 
		not planet "Hai-home"
		not planet "Mountaintop"
		not planet "Darkwaste"
		government "Hai"
	to offer
		has "Hai Building Mountaintop [2] Recruits: active"
	on offer
		conversation
			`You land on the world of <planet> and do your part to sell the opportunity on Mountaintop.`
				decline



mission "Hai Building Mountaintop [3] Furnishings"
	name "Retrieve human furnishings."
	description "The volunteers are so numerous, that they've worked out that the Hai aren't going to be able to coordinate a realistic access"
	autosave
	landing
	source "Mountaintop"
	stopover "Prime"
	destination "Mountaintop"
	clearance
	on visit
		dialog `You have arrived at the Mountaintop construction site but it isn't finished or staffed yet.`
	to offer
		has "Hai Building Mountaintop [2] Recruits: done"
	cargo "human furnishings" 200
	blocked `Sayari contacts you and says, "<first>, you're going to need two hundred tons of cargo space for this." You should return here after freeing up <capacity>.`
	on offer
		conversation
			`As you and Terry offload her remaining supplies on Mountaintop where she intends to manage the arrivals and setup personally, you get a communication from Sayari come to your personal device.`
			`	"Captain <last>! Glad I could get a hold of you on the other side of the wormhole there, I see the new relays are working."`
			`	"We've just discovered a problem, interest has soared in sign-ups for Mountaintop, but we've realised that most of our 'human' furnishings produced in Hai space aren't going to pass as having been manufactured with your technology. Mr Yang has pulled some strings, but now we urgently need someone to go pick them up from Prime in Betelgeuse."`
			`	"Everything else should be ready on our end soon enough, if you can just handle that pick-up and delivery we'll be ok."`
			`	You assure her you can handle a simple pick-up.`
				accept
	on stopover
		dialog `You have the furnishings the Hai ordered. It's time to return them to <destination>`
	on complete
		event "role-play station active" 12
		event "news: hai video clip debunked"
		log `Of all the hilariously mundane things that could trip up a deception, it turned out to be Hai-made furniture. Fortunately you were on hand to save the day by acquiring a large shipment of human-made furniture from Prime in order to complete the station.`
		conversation
			`By the time you return you are shocked to notice that the station seems to be rapidly approaching a completed state. Some four thousand people have already arrived, though some are still on board ships docked at the station. Once you register your delivery amidst the station chaos it's only a few minutes later that you get a "thank you" message from Sayari. She strongly recommends that you hang around Hai space for the time being while events are ongoing, with a cryptic "P.S. you may get a message from a friend of mine soon."`

event "role-play station active"
	system "Ultima Thule"
		government "Neutral"
		object
			sprite star/f0
			period 10
		object
			sprite planet/desert5
			distance 200
			period 22.3607
		object
			sprite planet/europa-b
			distance 403.41
			period 64.056
		object
			sprite planet/desert7-b
			distance 824.9
			period 187.302
		object
			sprite planet/gas1
			distance 1706.99
			period 557.553
			object
				sprite planet/ice8-b
				distance 216
				period 11.1964
		object "Wormhole Alpha"
			sprite planet/wormhole-syndicate-ad
				"frame rate" 1
				"random start frame"
			distance 4208.63
			period 2158.5
			object Mountaintop
				sprite "planet/station hai eight geocoris"
				distance 315
				period 31.1964
	planet Mountaintop
		government "Neutral"
		attributes station tourism
		landscape land/station5
		description `This brand new station is built with wide spacious interiors, though that is largely because it was built for having expansion room inside it to accomodate the Hai's preferred geometric development pattern and long-term perspectives. At the moment there is a number of hai pretending to be humans in costume, and a number of volunteer humans from Hai space helping to make up the act. A powerful holoprojection system is projecting an 'anomaly' into space nearby as a novelty. Some 'investigators' following rumours of the Hai are being entertained at most any time.`
		spaceport `The spaceport is a spacious docking assembly sheltered under broad carapace-like structures which are arrayed around the lower decks like petals. It is designed to look impressive and still has that shiny look and freshly oiled smell of a newly minted construction, though it has only basic facilities and services.`
		security 0.7
		"required reputation" -10
	
