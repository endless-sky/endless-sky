# Copyright (c) 2016 by Michael Zahniser
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.  See the GNU General Public License for more details.

# Definitions of Drak Archon locations

mission "Drak guarding Korath space"
	invisible
	landing
	npc kill
		government Drak
		personality heroic vindictive staying
		system Fasitopfar
		ship "Archon" "Kasiliri's Folly"
	npc kill
		government Drak
		personality heroic vindictive staying
		system Kasikfar
		ship "Archon B" "Sword of Eden"
	npc kill
		government Drak
		personality heroic vindictive staying
		system Peresedersi
		ship "Archon C" "Snows of Far Door Nai"

mission "Drak guarding Sayaiban"
	invisible
	landing
	npc kill
		government Drak
		personality heroic vindictive staying
		system Sayaiban
		ship "Archon" "Watchful Gravetender"
	on enter Sayaiban
		log "Factions" "Archons" `Archons consider it to be their job to enforce peace and to prevent extinction. If they are unable to prevent a species from driving itself extinct, they will still try to preserve some of what that species created as a memorial to them.`
			`They are capable of communicating telepathically.`
		conversation
			`A voice says, "This system is off limits. You should leave."`
			`	After a second, you realize that the voice did not come from your communications equipment. In fact, now that you think about it, you're not sure if it was an audible voice, or just something in your head.`
			choice
				`	(Ignore it.)`
				`	"Why should I leave?"`
					goto why
				`	"You can't tell me what to do."`
					goto why
			`	"You should leave." The thought repeats itself, insistently. Either you're going crazy, or a creature is communicating with you telepathically.`
			choice
				`	"Why should I leave?"`
				`	"You can't tell me what to do."`
			label why
			`	You feel as if a vast and patient creature has just heaved an immense sigh. "Human, you would do well not to ignore the warning of an Archon. I am here to warn off those who might be harmed by the swarm intelligence that infests this system. If you remain here long your ship will be digested by the swarm."`
			`	You recall that "Archon" is what Drak ships are called.`
			choice
				`	"What do you mean, 'digested'?"`
				`	"What is a 'swarm intelligence'?"`
					goto swarm
			`	"I mean that your ship will be broken down into its component parts." You notice, as the voice says this, that your shields are registering small energy bursts, as if they are being struck by invisible weapons.`
			`	"What is this swarm?" you ask.`
			label swarm
			`	"Self-replicating miniature robots," the voice replies. "A weapon created by the Korath, the last of their great abominations. If you wish to feed your ship to the swarm, I will not stop you, but they already possess enough raw material here without your assistance." The voice's tone, inasmuch as a disembodied imaginary voice can be said to have a tone, is sardonic.`
			choice
				`	"Okay, okay, I'll get out of here."`
					goto end
				`	"Wait, I have more questions."`
			`	"Yes?"`
			`	You ask, "Why don't you just destroy the swarm, if it is so dangerous?"`
			`	The voice says, "Because if the Korath manage to drive themselves extinct, this intelligence will be their last and greatest surviving creation, and we will preserve it as a living memorial to them. Please do not interfere here." When the voice speaks the phrase, "drive themselves extinct," the words are accompanied by an emotion that you cannot put a name to.`
			`	Also, the empty space around your ship is beginning to light up with small sparks, like an angry swarm of fireflies.`
			choice
				`	"Well, it's an honor to meet you. I'll be leaving now."`
					goto end
				`	"Why do you care if they go extinct?"`
			`	"Our directive is to enforce peace and prevent extinction," says the voice. As before, the words "prevent extinction" echo loud in your mind as if underlined by a nameless emotion. "Now, enough questions," says the voice.`
			label end
			`	The presence inside your head seems to fall away, and you are left talking to thin air.`
				decline

mission "Drak guarding Void Sprites"
	invisible
	landing
	npc kill
		government Drak
		personality heroic vindictive staying
		system Nenia
		ship "Archon (Cloaked)" "Sleeping Dragon"

########################################################################

# Koor'alei Skin story

mission "Ancient Skin [0] Installation"
	name "Ancient Skin: Quarg"
	description "Ask the Quarg about the ancient skin. Visit a Quarg world or station with the skin outfitted on your ship."
	source "Buccaneer Bay"
	clearance "When hailing the planet, you receive only landing coordinates."
	blocked "You can't pick up Lilith's present yet. Return when you have either 13 outfit space or 13 cargo space free."
	to offer
		or
			has "Warfeed Terraforming [R03] Secret Message (Definite): done"
			has "Warfeed Terraforming [R03] Secret Message (Chance): done"
	to complete
		never
	on offer
		outfit "Ancient Skin"
		log `Lilith installed skin from an ancient alien ship. It clung to my hull, repairing it in minutes, and rendered my ship invisible to scanners and radar. She asked me to destroy it so it does not fall into the wrong hands.`
		conversation
			`You see Lilith waiting for you at the entrance to the spaceport.`
			`	"Move your ship and I'll demonstrate how the skin works. You should visit the outfitter before you leave to decide whether to install it or put it in your cargo hold."`
			choice
				`	(Continue.)`
			`Lilith has you move your ship to a bay where the alien skin is attached to a crane. It is slowly lowered to the middle of the top of your ship. The skin is clearly too small to cover a useful area of the ship, so you wonder whether it will help at all.`
			`	"Watch this," says Lilith smugly.`
			`	When the crane releases the skin onto your ship, the skin quivers and shakes, as if it is pondering the same question that you were. Then it flattens and spreads out in tentacles along the ship's surface. It closes up holes in vulnerable areas, and you can see it repairing gashes from recent battle damage. In a few minutes, your hull is fully repaired and even the paint seems new. The alien skin is only visible as thin strands wrapping around your ship's hull.`
			choice
				`	(Continue.)`
			`	"Let me show you your ship on a scanner," says Lilith. The scanner shows the outline of your ship, details of the landing bay, and the spaceport beyond, but nothing within your ship. It takes almost a minute for telltale signs of the ship's interior to emerge.`
			`	"Now do you see why I don't want this to fall into the wrong hands?"`
			`	You think to yourself how you could destroy this, and the first word that comes to mind is, "Quarg."`
				accept

outfit "Ancient Skin"
	category "Systems"
	thumbnail "outfit/ancient scales"
	mass 25
	"outfit space" -13
	"energy consumption" 1.2
	"hull repair rate" 0.5
	"hull heat" 0.6
	"scan interference" 20
	"radar jamming" 200
	"ramscoop" 0.5
	description `These dense flakes of shape-shifting skin stretch and maneuver around the hull of your ship, sealing vulnerable parts and repairing flaws. Their strange physical properties confuse scanners and radars, rendering you nearly invulnerable to both. They also suck matter slowly from space, turning it into usable fuel. Unfortunately, the scales are quite dense and feed off your reactor's power.`
	description `	From what you've learned, these are the last remains of a living ship that crashed millions of years ago on Stormhold. When it was fully active, the skin was nearly invincible and rendered the ship invisible. Even in its dormant state, it is more advanced than Human technology. Your friend Lilith asked you to destroy it, lest this advanced technology fall into the wrong hands.`

# Has "ZZ" so it is after the Quarg first contact:
mission "ZZ Ancient Skin [1] Quarg Poetry Teacher and Quarg Scientist"
	name `Ancient Skin: <planet>`
	description `Go to <destination> to ask about the ancient skin.`
	landing
	source
		attributes quarg
	destination "Kuwaru Efreti"
	to offer
		has "Ancient Skin [0] Installation: active"
	on visit
		dialog `You could get information about your ancient skin here, if you remember to bring the skin.`
	on offer
		require "Ancient Skin"
		conversation
			`There are Quarg here who might be able to help you find a way to destroy the ancient skin, or at least understand what it is. Do you want to ask them?`
			choice
				`	(Yes.)`
				`	(No.)`
					defer
			`	You seek the nearest Quarg who has time to talk to you and bring them to your ship to show them the skin.`
			`	After a minute of contemplation, the Quarg responds, "I am merely a teacher of poetry and unwise in ways of science. I have heard of such a skin in legends of the Quarg. Great creatures in the sky taught the old races long before Quarg were born. The teachers were wise and ancient, old beyond recokning even by the measure of a Quarg. Destroying this skin would be a terrible tragedy.`
			`	"Go to <destination> and ask our scientists. They may tell you more."`
			`	The Quarg gives you what you guess to be coordinates on the ringworld. Hopefully the Quarg on <planet> will know what it means.`
				accept
	on accept
		fail "Ancient Skin [0] Installation"

mission "Ancient Skin [2] Quarg Scientist and Archon"
	name `Ancient Skin: Archon`
	description `Speak to the Drak Archon in the Fasitopfar system and return to <destination>.`
	source "Kuwaru Efreti"
	landing
	waypoint Fasitopfar
	to complete
		has "identified skin"
	to offer
		or
			has "ZZ Ancient Skin [1] Quarg Poetry Teacher and Quarg Scientist: done"
			has "ZZ Ancient Skin [1] Quarg Poetry Teacher and Quarg Scientist: active"
			has "Ancient Skin [0] Installation: active"
	on visit
		dialog `You could get information about your ancient skin here, if you remember to bring the skin.`
	on offer
		require "Ancient Skin"
		fail "ZZ Ancient Skin [1] Quarg Poetry Teacher and Quarg Scientist"
		conversation
			`You head to what looks like a transit hub and show a Quarg the address you were provided. You are ushered to a green sphere, about four meters in diameter. The surface of the sphere is transparent and you have no trouble stepping through. Once through, gravity vanishes, the surface solidifies, and is nearly opaque.`
			`	You can see vast swaths of ringworld rush by as you hover weightless in the middle of the sphere. After a few minutes, it stops at the opposite side of the solar system and you exit into a room with vaulted ceilings.`
			`	Ahead, you can see machinery that is quite alien to your eyes. It looks like a cross between abstract art sculptures, biological specimens, and optical circuits. Some are pulsating within a wide range of colors you suspect go beyond your eyes' sensitivity. There are wild variations in temperature and pressure, yet somehow the air remains stable.`
			choice
				`	(Continue.)`
			`	A Quarg notices your confusion and walks to you. "My name is Kalee-sen, a scientist of the Quarg. We know of your discovery and are analyzing it." You notice the skin has been removed from your ship and is on what looks like a hexagonal altar, seven meters wide.`
			`	"None of our weapons can pierce the skin, nor can our instruments look within. We have means to destroy it, but we wish to avoid using such devastating devices.`
			`	"The Drak are aware of the skin's presence. You are to bring it to the Archon in the Fasitopfar system. There, its fate will be decided.`
			`	"Return to your ship, and the skin will be there."`
				accept
	on complete
		conversation
			`You return to <planet> expecting to enter the Quarg's green transport orb, but you find Kalee-sen at the entrance to the station.`
			`	"Welcome <first> <last>, what did you learn?" From the tone of voice, you suspect he already knows, but it can be hard to read a person so alien as a Quarg.`
			`	You explain your experience with the Archon and Kalee-sen responds, "We will be ready when you are ready. Walk towards peace, <first> <last>."`

	on enter Fasitopfar
		log `The Drak say the skin I found was from the Koor'alei, an ancient race that died long ago protecting the Drak and others from a great threat. The Drak will "reawaken" the skin, giving it "new-found strength," if I prove to be a good peacemaker.`
		conversation
			apply
				set "identified skin"
			`You feel an intense rush of sensation in your mind, and a white light surrounds you. After a moment, the light and sensation vanish and you hear the voice of a Drak Archon.`
			choice
				`	(Continue.)`
			`	"The skin you found is that of a Koor'alei, ancient sages and teachers of the Drak. Their species is long dead, protecting the Drak and many others from a great threat. We thought no vestige remained, until now.`
			`	"The skin has found you, so you will protect it. Should you prove yourself a worthy peacemaker, we will bestow a gift upon you. We will reawaken the Koor'alei skin, and its new-found strength will be yours as well. When the time is right, you will know, and you will return to Kuwaru Efreti with the skin."`
			`	The voice vanishes, and the Archon appears to lose interest in speaking with you.`


outfit "Koor'alei Skin"
	category "Systems"
	thumbnail "outfit/ancient scales blue"
	mass 31
	"outfit space" -13

	# The energy consumption must be the same as Ancient Skin or
	# the player may be stranded on Kuwaru Efreti. Instead, the
	# balance comes from a disproportionate increase in hull heat
	# and an increase in mass.

	"energy consumption" 1.2
	"hull repair rate" 1.6
	"hull heat" 5
	"scan interference" 30
	"radar jamming" 300
	"ramscoop" 1
	description `These dense flakes of shape-shifting skin stretch and maneuver around the hull of your ship, sealing vulnerable parts and repairing flaws. Their strange physical properties confuse scanners and radars, rendering you nearly invulnerable to both. They also suck matter slowly from space, turning it into usable fuel. Unfortunately, the scales are quite dense and feed off your reactor's power.`
	description `	According to the Drak, this skin is the last remains of an ancient species of sages and teachers, the Koor'alei. After proving to the Drak that you are a peacemaker, they have "reawakened" the skin so you can deal with the troubles that lie ahead. That tripled the hull repair rate but made the skin denser and hotter.`

mission "Ancient Skin [3] Archon Reawaken Trigger"
	invisible
	landing
	source
		not attributes uninhabited
	to offer
		has "Ancient Skin [2] Quarg Scientist and Archon: done"
		has "main plot completed"
		has "Wanderers: Unfettered Diplomacy 1C: done"
		has "Remnant: Return the Samples 2: done"
		"reputation: Drak" > 0
	on offer
		event "archon reawaken allowed" 30
		fail

event "archon reawaken allowed"

mission "Ancient Skin [4] Archon Reawakening Permission"
	name `Ancient Skin: <planet>`
	description `Visit the spaceport at <destination> to reawaken the ancient skin.`
	landing
	source
		not planet "Kuwaru Efreti"
	destination "Kuwaru Efreti"
	to offer
		has "event: archon reawaken allowed"
		"reputation: Drak" >= 0
	on visit
		dialog `You could reawaken your ancient skin here, if you remember to bring it.`
	on offer
		require "Ancient Skin"
		conversation
			`You feel a faint whisper in your head. The words are imperceptible, but they're accompanied by a powerful emotion. The meaning is clear: the Drak have judged you worthy, and will allow the ancient skin to be reawakened. You must take it to Kuwaru Efreti, as they instructed before.`
				accept
	on complete
		outfit "Ancient Skin" -1
		outfit "Koor'alei Skin" 1
		conversation
			`You travel through the Quarg station using the same green orb elevator as before, and find yourself in the Quarg laboratory. Its entire contents have been rearranged, and there are far more Quarg than before. A collection of scientists stands before you, with a wide assortment of devices.`
			choice
				`	(Continue.)`
			`	The ancient skin is hovering in midair between two devices that don't look at all like Quarg construction. They're a pair of curved black columns with white spikes pointing in the direction of the skin. The columns look almost alive with pulsating veins and what looks like a heart. Are you witnessing Drak technology?`
			`	The skin begins to glow brighter and brighter until it is bright as the sun; far too bright to look at. Before you can cover your eyes, a powerful shockwave emanates from the skin. You're thrown onto the floor and you can feel the room heating up. At rising volume, you hear loud humming and deep bass vibration so powerful you can feel them in your bones.`
			choice
				`	(Continue.)`
			`	The spectacle ends after a few seconds when the room turns almost pitch black. It seems that even the Quarg were surprised by the intensity of the effect. They look up in wonder at a device they scarcely understand, and a relic of the ancient past, from an era of knowledge long forgotten.`
			`	You can feel a presence in your head, sent by a powerful telepathic entity. It feels different than the touch of an Archon's mind. It is warm and welcoming, rather than the Archon's cold and demanding nature. It sends you a mix of hope, gratitude, and longing. Is this the last vestige of the mind of a Koor'alei; what little remains in this tiny scrap of skin?`
				decline
