- Feature Name: `plugin_index`
- Affected audience: Plugin Authors, Game/Tool Developers
- RFC PR: [EndlessSkyCommunity/endless-sky#53](https://github.com/EndlessSkyCommunity/endless-sky/pull/53)
- Relevant Issues/RFCs: [endless-sky-#707](https://github.com/endless-sky/endless-sky/issues/707)

# Summary

This is a specification for the creation and format of a central Plugin Index, as discussed in [endless-sky-plugins#21](https://github.com/EndlessSkyCommunity/endless-sky-plugins/pull/21).

## Intended users

Intended first-level users are applications that can query the index in order to display, install or update Plugins. Examples include [ESLauncher2](https://github.com/EndlessSkyCommunity/ESLauncher2/), Endless Sky's website (as discussed in [endless-sky.github.io#21](https://github.com/endless-sky/endless-sky.github.io/pull/21)) and Endless Sky itself (as discussed in [ES-#707](https://github.com/endless-sky/endless-sky/issues/707)).

Second-level users are players that want a convenient way to discover or install Plugins.

## Scope limits

Out of scope for this specification are:
- Behavior, implementation or appearance of Applications using this index.
- The exact format of autogenerated files.
- Fields for version-incompatibility are not included, but can be added later by adding new keys to the Plugin map.


# Detailed Design

## Structure

- The Plugin Index takes the form of a Git repository. For first-level users, everything important is on the `master`-branch.
- The repository contains:
  - A folder that contains a human- and machine-readable YAML-file for each Plugin, hereafter referred to as the Plugin's "Manifest".
  - Scripts that automatically convert the Manifests to other machine-readable formats, for maximum compatibility.
  - A folder containing the files generated from the Manifests.
  - A script that is able to check for new Plugin versions.


## The generated files

The generated files should be updated by a CI service upon every change to the Manifest. They may take the following forms (or others):
- A JSON-file, containing all Plugins
- A number of JSON-files, each named after a plugin which it contains
- A .txt file in a format readable by Endless Sky, containing all Plugins.


## The Manifest

Each Plugin has its own Manifest, which contains a map with the following contents. Unless otherwise stated, the associated values are Strings.

- `name`: A unique name identifying the Plugin.
- `authors`: One or more authors of the Plugin, for example `Somename, SomeOtherName & Contributors`.
- `homepage`: A valid URL pointing at a page containing more information about the Plugin.
- `license`: A license identifier in accordance with the [SPDX license list](https://spdx.org/licenses/).
- `version`: The Plugin's version, as currently indexed.
- `shortDescription`:  A short text describing the Plugin. **Should** be less than 150 and **must** be less than 200 characters.
- `description`:  A text of arbitrary length describing the Plugin, similar to the Plugin's `about.txt`.
- `url`: A valid URL pointing directly (redirects are allowed) at a Zip-archive containing release `version` of the Plugin.
- `iconUrl`: A valid URL pointing directly (redirects are allowed) at a PNG- or JPEG-image that is used as the Plugin's thumbnail. The image should preferably be 160x160 pixels large and may have a transparent background.
- `autoupdate`: A map containing information that can be used by aforementioned update script to check for new versions and automatically update the Plugin's key-value pairs accordingly (See the Example below).
  - `type`: An enum identifying the method used to check for new versions. Possible values:
    - `tag`: Clones `update_url` as git repository and checks for new tags.
    - `commit`: Clones `update_url` as git repository and checks `branch` for new commits.
  - `update_url`: A valid URL complementing `type`. May be omitted, in which case `homepage` shall be used instead.
  - `branch`: Allows for special branches to be used when `type` is `commit`. If omitted, the default branch will be used instead.
  - Any other key-value pairs will be interpreted as update keys:
    - They may contain `$version` as a substitution key
    - Upon detecting a new version, all occurences of `$version` will be replaced with the version detected using `type`.
    - Then, they will replace the Plugin's keys of the same name.
    - For example: A universally-used update key should be `url`, with a value similar to `https://example.com/myPlugin/$version.zip`. Upon detecting a new version (say, `v1.2`), the Plugin's `url` key will be replaced with `https://example.com/myPlugin/v1.2.zip`, altering `plugins.yml`. This altered version can then be used to - manually or automatically via CI - create a PR with the new version. Once the PR is merged, a CI run will update the autogenerated files accordingly.

### Examples

A typical Manifest might look like this:
```yaml
name: My Awesome Plugin!
authors: HelpfulContributor
homepage: https://github.com/HelpfulContributor/ES-Plugin
license: GPL-3.0-or-later
version: v1.1
shortDescription: A small plugin for Endless Sky expressing my compassion for the game!
description: >- # One of the many ways to do multiline-strings in YAML. This version allows for linebreaks, but strips them away while parsing. See https://yaml-multiline.info/
  Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
  Ipsum dolor sit amet consectetur adipiscing elit pellentesque habitant. Mauris augue neque gravida in. Ultricies integer quis auctor elit.
  Suspendisse ultrices gravida dictum fusce ut placerat. Sollicitudin tempor id eu nisl nunc mi. Molestie at elementum eu facilisis sed odio morbi quis commodo.
  Justo donec enim diam vulputate ut pharetra sit amet aliquam. Ut venenatis tellus in metus vulputate eu scelerisque felis.
  Elementum curabitur vitae nunc sed velit. Sit amet consectetur adipiscing elit duis tristique sollicitudin nibh sit. Feugiat scelerisque varius morbi enim.
url: https://github.com/HelpfulContributor/ES-Plugin/archive/v1.1.zip
iconUrl: https://raw.githubusercontent.com/HelpfulContributor/ES-Plugin/v1.1/icon.png
autoupdate:
  type: tag
# We can omit `update_url`, since `homepage` also resolves to a valid git URL.
  url: https://github.com/HelpfulContributor/ES-Plugin/archive/$version.zip # Specifies what to set `url` to if an update has been found. Notice the $version substitution
  iconUrl: https://raw.githubusercontent.com/HelpfulContributor/ES-Plugin/$version/icon.png # Dito
```

Now let's say `@HelpfulContributor` releases a new version `v2.0`. They do so by pushing a new tag to their git repository.

The Plugin Index's CI will periodically run the autoupdate script over all Manifest. In this case, the script will check `homepage` (because `update_url` wasn't specified) for a new tag. Once found, it replaces the `$version` in our update keys with the name of the tag (`v2.0`). The Plugin's `url` and `iconUrl` are subsequently ovewritten with the resulting strings.

Thus, the Manifest would now look like this:
```yaml
name: My Awesome Plugin!
authors: HelpfulContributor
homepage: https://github.com/HelpfulContributor/ES-Plugin
license: GPL-3.0-or-later
version: v2.0 # Changed automatically
shortDescription: A small plugin for Endless Sky expressing my compassion for the game!
description: >-
  Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
  Ipsum dolor sit amet consectetur adipiscing elit pellentesque habitant. Mauris augue neque gravida in. Ultricies integer quis auctor elit.
  Suspendisse ultrices gravida dictum fusce ut placerat. Sollicitudin tempor id eu nisl nunc mi. Molestie at elementum eu facilisis sed odio morbi quis commodo.
  Justo donec enim diam vulputate ut pharetra sit amet aliquam. Ut venenatis tellus in metus vulputate eu scelerisque felis.
  Elementum curabitur vitae nunc sed velit. Sit amet consectetur adipiscing elit duis tristique sollicitudin nibh sit. Feugiat scelerisque varius morbi enim.
url: https://github.com/HelpfulContributor/ES-Plugin/archive/v2.0.zip # Changed because there was an update key with the same name
iconUrl: https://raw.githubusercontent.com/HelpfulContributor/ES-Plugin/v2.0/icon.png # Dito
autoupdate:
  type: tag
  url: https://github.com/HelpfulContributor/ES-Plugin/archive/$version.zipsubstitution
  iconUrl: https://raw.githubusercontent.com/HelpfulContributor/ES-Plugin/$version/icon.png
```

This changed Manifest can then be PR'd back to the Plugin Index's master branch.
